# openstack-testdrive-config

In the ravello directory you'll find ansible playbooks to configure the OpenStack Test Drive environment, as well as a tool to automatically generate an inventory file from published Ravello applications.

## License clarification

Unless otherwise noticed in the file itself, the content of this repository is GPL v3.0 licensed.

## Pre-requisites

1. python-pip and python-virtualenv packages
1. Python SDK for the Ravello API
1. git package
1. openstack-testdrive-config repository contents (aka this repository)

## Installation

### python-pip and python-virtutalenv packages

**Fedora**

Simply install python-pip and python-virtualenv RPMs.

```
$ su -c 'dnf install python-pip python-virtualenv'
```

**RHEL 7**

At least rhel-7-server-rpms and EPEL repository should be enabled in the system.

Enabling EPEL:

```
$ su -c 'rpm -Uvh http://download.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-10.noarch.rpm'
```

Installing python-pip and python-virtualenv:

```
$ su -c 'yum install python2-pip python-virtualenv'
```

### Python SDK for the Ravello API

Recommeded to install it using virtualenv as a regular user, as explained below:

```
$ virtualenv --system-site-packages ~/ravello-sdk
$ source ~/ravello-sdk/bin/activate
$ pip install ravello-sdk
```

### git package

Install git package.

**Fedora**

```
$ su -c 'dnf install git'
```

**RHEL 7**

```
$ su -c 'yum install git'
```

### openstack-testdrive-config repository contents

Clone the openstack-testdrive-config repository to the desired location, as a regular user.

```
$ cd ~
$ git clone https://github.com/vagnerfarias/openstack-testdrive-config.git
```

## Usage

### Publish OpenStack Test Drive Ravello Application

Based on the Ravello blueprint made available to you, publish as many applications you need. But in order to have the ansible inventory properly generated (next step), the name should have the following format:

1. A prefix string, common to all applications. Eg. LATAM-<subregion>-OSP-TestDrive-<some_identifier>-
1. A sequence number.

For example, application name could be: 

* OpenStack-Testdrive-CustomerName-01, OpenStack-Testdrive-CustomerName-02, etc;
* OpenStack-Testdrive-EventName-01, OpenStack-Testdrive-EventName-02, etc.

Note that your Ravello administrator may have configured specific rules regarding application names. From this tooling perspective, you can name the applications the way you'd like, as long as you have a common prefix.

### Generate Ansible Inventory

The ansible inventory is generated by connecting to Ravello and listing all applications with the provided name prefix. ravelloconfig.py syntax is:

```
ravelloconfig.py -u [username] -o [inventory-file] -f [app-name-prefix]
```

*Note:* if your organization has an _identity domain_, the username will be like "identity_domain/username". Eg. a123456/vfarias.

The following example will generate an ansible inventory file at ~/openstack-testdrive-config/ansible/hosts, including all applications with name prefix "OpenStack-Testdrive-CustomerName".

```
$ source ~/ravello-sdk/bin/activate
$ cd ~/openstack-testdrive-config/ravello/tools
$ ./ravelloconfig.py -u a123456/vfarias -o ../ansible/hosts -f OpenStack-Testdrive-CustomerName

```

### Configure ssh keys

Current version of this configuration tool has some limitations:

* The same ssh public key must be deployed to all applications, which means Test Drive attendants will share the same ssh private key.
* The ssh private key for the heat-admin user must be manually downloaded from the Director node to the system used to run the playbook.

Because of that, you need to manually edit tdconfig.yaml and download the heat-admin ssh private key, as follows:

#### Set the path to ssh public key to be used by attendants.

```
  tasks:
    - name: Set authorized keys for instructor
      become: yes 
      authorized_key:
        user: stack
        state: present
        key: "{{ lookup('file', '/path/to/ssh-public-key') }}"
```

#### Download heat-admin ssh private key from OpenStack Director node

Use scp to get the ssh private key from any enviroment. It'll be at ~stack/.ssh/id_rsa.

```
$ scp stack@<director-node>:.ssh/id_rsa ~/heat-admin-sshkey
$ chmod 600 ~/heat-admin-sshkey
```

#### Set the path for heat-admin ssh private key in tdconfig.yaml

```
- hosts: overcloud-all
  vars:
    ansible_user: heat-admin
    ansible_ssh_private_key_file: /path/to/heat-admin-sshkey
  gather_facts: no
```

### Run the configuration Ansible playbook

After generating the ansible inventory and starting all the applications, it's time to run the playbook and configure the environment.

In order to check if all the nodes, in all environments, are up and running, run:

```
$ cd ~/openstack-testdrive-config/ansible
$ ansible-playbook -i hosts ping.yaml
```

After you verified that all nodes are running, execute the configuration playbook:

```
$ ansible-playbook -i hosts tdconfig.yaml
```

When the playbook finishes, the ssh public key that will be used by attendants will be included in Director node authorized_keys and also novncproxy_proxy_base_url will be set to the correct value.

